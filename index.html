<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GitHub Pages Firebase ç·¨è¼¯ç¯„ä¾‹</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f0f2f5; }
        .container { 
            max-width: 700px; 
            margin: 0 auto; 
            background-color: #fff; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #1a237e; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; }
        h2 { color: #004d99; margin-top: 25px; }
        
        /* å…¬é–‹é¡¯ç¤ºå€ */
        #public-display {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            font-size: 1.1em;
        }

        /* ç™»å…¥å€ */
        #login-section {
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        /* ç·¨è¼¯å€ */
        #edit-section { 
            background-color: #e6f7ff; 
            padding: 20px;
            border-radius: 8px;
        }
        .hidden { display: none !important; }
        
        input[type="email"], input[type="password"], textarea, button { 
            padding: 10px; 
            margin-top: 10px; 
            display: block; 
            width: 100%; 
            box-sizing: border-box; 
            border-radius: 5px;
        }
        input, textarea { border: 1px solid #ccc; }
        label { margin-top: 15px; display: block; font-weight: bold; }
        
        button { 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s; 
            margin-top: 15px;
        }
        #loginBtn { background-color: #004d99; color: white; }
        #loginBtn:hover { background-color: #1a237e; }
        #saveBtn { background-color: #4caf50; color: white; }
        #saveBtn:hover { background-color: #3e8e41; }
        #signOutBtn { background-color: #f44336; color: white; }
        #signOutBtn:hover { background-color: #d32f2f; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-globe-asia"></i> å…¬é–‹å…§å®¹é¡¯ç¤ºå€</h1>
    <p>ä»¥ä¸‹å…§å®¹ç”±ç®¡ç†å“¡ç·¨è¼¯ä¸¦å„²å­˜åœ¨é›²ç«¯ï¼Œä»»ä½•äººéƒ½èƒ½å³æ™‚çœ‹åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚</p>
    
    <div id="public-display">
        <p>è¼‰å…¥ä¸­...</p>
    </div>

    <hr>

    <h2><i class="fas fa-lock"></i> ç®¡ç†å“¡ç™»å…¥</h2>
    
    <div id="login-section">
        <input type="email" id="email" placeholder="ç®¡ç†å“¡ Email" required>
        <input type="password" id="password" placeholder="å¯†ç¢¼" required>
        <button id="loginBtn" onclick="signIn()"><i class="fas fa-sign-in-alt"></i> ç™»å…¥</button>
        <p id="login-message" style="color: #f44336; margin-top: 10px; font-weight: bold;"></p>
    </div>

    <div id="edit-section" class="hidden">
        <h3><i class="fas fa-user-edit"></i> æ–°å¢å…¬é–‹è¨Šæ¯ (<span id="user-email"></span>)</h3>
        <label for="editor-text">è¼¸å…¥æ–°è¨Šæ¯ï¼š</label>
        <textarea id="editor-text" rows="5" placeholder="è«‹è¼¸å…¥æ‚¨è¦æ–°å¢çš„è¨Šæ¯..."></textarea>
        
        <button id="saveBtn" onclick="saveContent()"><i class="fas fa-save"></i> å„²å­˜ä¸¦å…¬é–‹</button>
        <button id="signOutBtn" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
        
        <p id="save-message" style="color: #4caf50; margin-top: 10px; font-weight: bold;"></p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // ** 1. æ‚¨çš„ Firebase é…ç½® (ä¿æŒä¸è®Š) **
    const firebaseConfig = {
        apiKey: "AIzaSyACnoimIASfb1rb59SbgLDkUmyYR6ODbUU",
        authDomain: "llwb-ed686.firebaseapp.com",
        projectId: "llwb-ed686",
        storageBucket: "llwb-ed686.firebasestorage.app",
        messagingSenderId: "940345852074",
        appId: "1:940345852074:web:7a30cca5a6d997a92350d3",
        measurementId: "G-KWL4ZE3D18"
    };

    // åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œæœå‹™
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const db = app.firestore();

    // ğŸš¨ è®Šæ›´ï¼šç¾åœ¨æŒ‡å‘ Collection (é›†åˆ) è€Œä¸æ˜¯ Document (æ–‡ä»¶)
    const PUBLIC_CONTENT_COLLECTION_REF = db.collection("content"); 
    
    // HTML å…ƒç´ å¿«å– (ä¿æŒä¸è®Š)
    const publicDisplay = document.getElementById('public-display');
    const loginSection = document.getElementById('login-section');
    const editSection = document.getElementById('edit-section');
    const editorTextarea = document.getElementById('editor-text');
    const loginMessage = document.getElementById('login-message');
    const saveMessage = document.getElementById('save-message');
    const userEmailSpan = document.getElementById('user-email');

    // ** 2. ç™»å…¥/ç™»å‡ºåŠŸèƒ½ (ä¿æŒä¸è®Š) **
    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        loginMessage.textContent = '';
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            loginMessage.textContent = `ç™»å…¥å¤±æ•—: ${error.message}`;
        }
    }

    function signOut() {
        auth.signOut();
    }

    // ** 3. ç›£è½ç™»å…¥ç‹€æ…‹èˆ‡ UI åˆ‡æ› (ä¿æŒä¸è®Š) **
    auth.onAuthStateChanged(user => {
        if (user) {
            loginSection.classList.add('hidden');
            editSection.classList.remove('hidden');
            userEmailSpan.textContent = user.email;
            // ç™»å…¥æ™‚æ¸…é™¤è¼¸å…¥æ¡†ï¼Œæº–å‚™æ–°å¢è¨Šæ¯
            editorTextarea.value = '';
        } else {
            loginSection.classList.remove('hidden');
            editSection.classList.add('hidden');
            userEmailSpan.textContent = ''; 
            loginMessage.textContent = '';
        }
    });

    // ** 4. è®€å–å…¬é–‹å…§å®¹ (å³æ™‚ç›£è½ï¼šè®€å–æ•´å€‹é›†åˆä¸¦é¡¯ç¤º) **
    // ğŸš¨ è®Šæ›´ï¼šä½¿ç”¨ orderBy æ’åºï¼Œä¸¦éæ­· snapshot ä¸­çš„æ‰€æœ‰æ–‡ä»¶
    PUBLIC_CONTENT_COLLECTION_REF
        .orderBy("timestamp", "desc") // æŒ‰æ™‚é–“æˆ³è¨˜é™åºæ’åˆ— (æœ€æ–°åœ¨æœ€ä¸Š)
        .limit(20) // é™åˆ¶æœ€å¤šé¡¯ç¤º 20 æ¢è¨Šæ¯
        .onSnapshot((snapshot) => {
            let html = '<ul style="list-style: none; padding: 0;">';
            
            if (snapshot.empty) {
                publicDisplay.innerHTML = '<p>ç›®å‰æ²’æœ‰ä»»ä½•å…¬é–‹è¨Šæ¯ã€‚</p>';
                return;
            }

            // éæ­·é›†åˆä¸­çš„æ¯å€‹æ–‡ä»¶ (æ¯æ¢è¨Šæ¯)
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? data.timestamp.toDate().toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' }) : 'æ™‚é–“æœªçŸ¥';
                
                html += `
                    <li style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; background-color: #fff;">
                        <p style="margin: 0; font-size: 0.9em; color: #666;">
                            [${date}] ç”± <strong>${data.author || 'åŒ¿åç·¨è¼¯è€…'}</strong> æ–°å¢
                        </p>
                        <p style="white-space: pre-wrap; margin-top: 10px; font-size: 1.1em;">
                            ${data.text}
                        </p>
                    </li>
                `;
            });
            html += '</ul>';
            publicDisplay.innerHTML = html;
        }, (error) => {
            console.error("è®€å– Firestore é›†åˆéŒ¯èª¤: ", error);
            publicDisplay.textContent = 'è³‡æ–™è®€å–éŒ¯èª¤ã€‚';
        });


    // ** 5. å„²å­˜/ç·¨è¼¯å…§å®¹ (æ–°å¢æ–‡ä»¶åˆ°é›†åˆ) **
    async function saveContent() {
        if (!auth.currentUser) {
            alert('æ‚¨å¿…é ˆç™»å…¥æ‰èƒ½å„²å­˜ï¼');
            return;
        }

        const newContent = editorTextarea.value.trim(); // ç§»é™¤å‰å¾Œç©ºç™½
        if (newContent.length === 0) {
            alert('è¨Šæ¯å…§å®¹ä¸å¯ç‚ºç©ºï¼');
            return;
        }
        
        saveMessage.textContent = 'å„²å­˜ä¸­...';

        try {
            // ğŸš¨ è®Šæ›´ï¼šä½¿ç”¨ add() æ–¹æ³•ï¼Œæ–°å¢ä¸€å€‹æ–°çš„æ–‡ä»¶åˆ°é›†åˆä¸­
            await PUBLIC_CONTENT_COLLECTION_REF.add({
                text: newContent,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                author: auth.currentUser.email
            });
            
            // æ–°å¢æˆåŠŸå¾Œï¼Œæ¸…é™¤è¼¸å…¥æ¡†
            editorTextarea.value = '';
            saveMessage.textContent = 'è¨Šæ¯æ–°å¢æˆåŠŸï¼å…¬é–‹åˆ—è¡¨å·²æ›´æ–°ã€‚';
            setTimeout(() => saveMessage.textContent = '', 3000); 

        } catch (error) {
            console.error("å¯«å…¥ Firestore éŒ¯èª¤: ", error);
            saveMessage.textContent = `å„²å­˜å¤±æ•—: ${error.message}`;
        }
    }

</script>

</body>
</html>
