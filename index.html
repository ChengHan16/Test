<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // ** 1. 替換為您的 Firebase 配置 **
    const firebaseConfig = {
        apiKey: "AIzaSyACnoimIASfb1rb59SbgLDkUmyYR6ODbUU",
        authDomain: "llwb-ed686.firebaseapp.com",
        projectId: "llwb-ed686",
        storageBucket: "llwb-ed686.firebasestorage.app",
        messagingSenderId: "940345852074",
        appId: "1:940345852074:web:7a30cca5a6d997a92350d3",
        measurementId: "G-KWL4ZE3D18"
    };

    // ** 新增：私人頁面網址 **
    const PRIVATE_PAGE_URL = 'private.html'; 

    // 初始化 Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const db = app.firestore();

    const PUBLIC_CONTENT_DOC_REF = db.collection("content").doc("main_data");

    // HTML 元素
    const publicDisplay = document.getElementById('public-display');
    const loginSection = document.getElementById('login-section');
    const editSection = document.getElementById('edit-section');
    const editorTextarea = document.getElementById('editor-text');
    const loginMessage = document.getElementById('login-message');
    const saveMessage = document.getElementById('save-message');
    const userEmailSpan = document.getElementById('user-email');

    // ** 2. 登入/登出功能 **
    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        loginMessage.textContent = '';
        try {
            await auth.signInWithEmailAndPassword(email, password);
            // 登入成功後，onAuthStateChanged 會處理 UI 變更 (跳轉)
        } catch (error) {
            loginMessage.textContent = `登入失敗: ${error.message}`;
        }
    }

    function signOut() {
        // 登出後，onAuthStateChanged 會將使用者導回 login.html/index.html
        auth.signOut();
    }

    // ** 3. 監聽登入狀態與 UI 切換 (修正跳轉邏輯) **
    auth.onAuthStateChanged(user => {
        if (user) {
            // 已登入
            
            // 如果使用者仍在登入頁面 (index.html)，則自動跳轉到編輯頁面 (private.html)
            if (window.location.pathname.endsWith('index.html') || window.location.pathname.endsWith('/')) {
                window.location.href = PRIVATE_PAGE_URL;
            }
            // 由於已跳轉，以下同頁面切換可以省略，但保留亦可。
            loginSection.classList.add('hidden');
            editSection.classList.remove('hidden');
            userEmailSpan.textContent = user.email;

        } else {
            // 未登入
            loginSection.classList.remove('hidden');
            editSection.classList.add('hidden');
            userEmailSpan.textContent = '';
            loginMessage.textContent = ''; 
        }
    });

    // ** 4. 讀取公開內容 (即時監聽) **
    // 由於登入後會跳轉，這段代碼的即時監聽功能主要服務於未登入的訪客
    PUBLIC_CONTENT_DOC_REF.onSnapshot((doc) => {
        if (doc.exists) {
            const data = doc.data();
            // 更新公開顯示區域
            publicDisplay.innerHTML = `<pre>${data.text || '目前沒有內容。'}</pre>`;

            // 如果使用者已登入，將內容同步到編輯器中 (這在跳轉後幾乎不執行，因為編輯器在 private.html)
            if (auth.currentUser) {
                editorTextarea.value = data.text || '';
            }
        } else {
            publicDisplay.textContent = '資料庫中尚未建立內容。';
        }
    }, (error) => {
        console.error("讀取 Firestore 錯誤: ", error);
        publicDisplay.textContent = '資料讀取錯誤。';
    });


    // ** 5. 儲存/編輯內容 (需登入授權) **
    // 由於登入後會跳轉，這段儲存代碼也只在同頁面編輯時有效。
    // 在您的架構中，編輯功能主要應放置於 private.html 中。
    async function saveContent() {
        // ... (保持原樣，但在新架構中主要由 private.html 負責)
        if (!auth.currentUser) {
            alert('您必須登入才能儲存！');
            return;
        }

        const newContent = editorTextarea.value;
        saveMessage.textContent = '儲存中...';

        try {
            // 寫入資料到 Firestore
            await PUBLIC_CONTENT_DOC_REF.set({
                text: newContent,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            saveMessage.textContent = '儲存成功！';
            setTimeout(() => saveMessage.textContent = '', 3000); 

        } catch (error) {
            console.error("寫入 Firestore 錯誤: ", error);
            saveMessage.textContent = `儲存失敗: ${error.message}`;
        }
    }

</script>
